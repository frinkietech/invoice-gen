<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FrinkieTech Network Invoice Generator</title>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f2f5; padding: 20px; margin: 0; }
    .container { max-width: 1100px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    h1 { text-align: center; color: #2563eb; }
    .card { background: #fafafa; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #e5e7eb; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    label { display: block; margin: 12px 0 6px; font-weight: 600; color: #374151; }
    input, select, textarea { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 15px; }
    button { background: #6d28d9; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin: 10px 5px 0 0; }
    button:hover { background: #5b21b6; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th, td { border: 1px solid #e5e7eb; padding: 12px; text-align: left; }
    th { background: #f3f4f6; }
    .text-right { text-align: right; }
    .actions { text-align: center; margin: 30px 0; }
    #invoicePreview { padding: 40px; background: white; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>FrinkieTech Network Invoice Generator</h1>
    <div class="card"><strong>Fill the form → Click Preview → Download beautiful PDF</strong></div>

    <!-- Same input fields as before, only preview changed -->
    <div class="card">
      <h2>Company Details</h2>
      <div class="grid">
        <div>
          <label>Company Name</label>
          <input type="text" id="companyName" value="FrinkieTech Network" />
          <label>Address</label>
          <textarea id="companyAddress">Juja, Kiambu 00900
Kenya</textarea>
          <label>Phone</label>
          <input type="text" id="companyPhone" value="+254799580711" />
          <label>Upload Logo (recommended 200×200px)</label>
          <input type="file" id="logoUpload" accept="image/*" />
        </div>
        <div>
          <label>Invoice Number</label>
          <input type="text" id="invoiceNo" value="INV-2026-005" />
          <label>Issue Date</label>
          <input type="date" id="invoiceDate" />
          <label>Due Date</label>
          <input type="date" id="dueDate" />
          <label>Currency</label>
          <select id="currency"><option value="KES">KES - Kenya Shillings</option></select>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>To (Client)</h2>
      <div class="grid">
        <div>
          <label>Client Name</label>
          <input type="text" id="clientName" value="Delights Labs Technologies" />
          <label>Client Address</label>
          <textarea id="clientAddress">Nairobi
Kenya</textarea>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Items / Services</h2>
      <table id="itemsTable">
        <thead><tr>
          <th>Description</th><th>Qty</th><th>Rate</th><th>Amount</th><th></th>
        </tr></thead>
        <tbody>
          <tr>
            <td><input type="text" class="desc" value="Continued Network infrastructure on call support & Network configuration training" style="border:none; width:100%; padding:8px;" /></td>
            <td><input type="number" class="qty" value="1" min="1" style="width:60px;" /></td>
            <td><input type="number" class="price" value="1000" step="0.01" style="width:100px;" /></td>
            <td class="lineTotal text-right">KES 1,000.00</td>
            <td><button type="button" onclick="this.closest('tr').remove();calculateTotal()">X</button></td>
          </tr>
        </tbody>
      </table>
      <button type="button" onclick="addRow()">+ Add Item</button>
    </div>

    <div class="card">
      <h2>Payment Details</h2>
      <div style="margin-bottom: 15px;">
        <label style="display: flex; align-items: center; margin: 0 15px 10px 0; font-weight: 600;">
          <input type="radio" name="paymentType" value="number" checked onchange="togglePaymentFields()" style="margin-right: 8px; width: auto;"/>
          Send Money to MPESA Number
        </label>
        <label style="display: flex; align-items: center; margin: 0; font-weight: 600;">
          <input type="radio" name="paymentType" value="till" onchange="togglePaymentFields()" style="margin-right: 8px; width: auto;"/>
          Send Money to MPESA Till
        </label>
      </div>
      <div class="grid">
        <div id="mpesaNumberDiv">
          <label>MPESA Phone Number</label>
          <input type="text" id="mpesaNumber" placeholder="e.g., +254799580711" />
        </div>
        <div id="mpesaTillDiv" class="hidden">
          <label>MPESA Till Number</label>
          <input type="text" id="mpesaTill" placeholder="e.g., 123456" />
        </div>
      </div>
    </div>

    <div class="actions">
      <button onclick="previewInvoice()">Preview Invoice</button>
      <button onclick="downloadPDF()">Download PDF</button>
    </div>

    <div id="invoicePreview" class="hidden"></div>
  </div>

  <script>
    // Toggle payment fields visibility
    function togglePaymentFields() {
      const paymentType = document.querySelector('input[name="paymentType"]:checked').value;
      document.getElementById('mpesaNumberDiv').classList.toggle('hidden', paymentType !== 'number');
      document.getElementById('mpesaTillDiv').classList.toggle('hidden', paymentType !== 'till');
    }

    // Default dates
    document.getElementById('invoiceDate').valueAsDate = new Date();
    const due = new Date(); due.setDate(due.getDate() + 7);
    document.getElementById('dueDate').valueAsDate = due;

    function addRow() {
      const tbody = document.querySelector('#itemsTable tbody');
      const row = tbody.insertRow();
      row.innerHTML = `<td><input type="text" class="desc" style="border:none;width:100%;padding:8px;" /></td>
        <td><input type="number" class="qty" value="1" min="1" style="width:60px;" /></td>
        <td><input type="number" class="price" value="0" step="0.01" style="width:100px;" /></td>
        <td class="lineTotal text-right">KES 0.00</td>
        <td><button type="button" onclick="this.closest('tr').remove();calculateTotal()">X</button></td>`;
      row.querySelectorAll('input').forEach(i => i.addEventListener('input', calculateTotal));
    }

    document.querySelectorAll('#itemsTable input').forEach(i => i.addEventListener('input', calculateTotal));

    function calculateTotal() {
      let total = 0;
      document.querySelectorAll('#itemsTable tbody tr').forEach(row => {
        const qty = parseFloat(row.querySelector('.qty').value) || 0;
        const price = parseFloat(row.querySelector('.price').value) || 0;
        const amount = qty * price;
        row.querySelector('.lineTotal').textContent = 'KES ' + amount.toLocaleString('en-KE', {minimumFractionDigits: 2});
        total += amount;
      });
      if (document.getElementById('invoicePreview').innerHTML) previewInvoice();
    }

    function previewInvoice() {
      const logoFile = document.getElementById('logoUpload').files[0];
      const logoURL = logoFile ? URL.createObjectURL(logoFile) : '';

      let itemsHTML = '';
      let total = 0;
      document.querySelectorAll('#itemsTable tbody tr').forEach(row => {
        const desc = row.querySelector('.desc').value;
        const qty = row.querySelector('.qty').value;
        const price = parseFloat(row.querySelector('.price').value).toLocaleString('en-KE', {minimumFractionDigits: 2});
        const amount = (parseFloat(row.querySelector('.price').value) * parseFloat(qty)).toLocaleString('en-KE', {minimumFractionDigits: 2});
        total += parseFloat(row.querySelector('.price').value) * parseFloat(qty);
        itemsHTML += `<tr style="border-bottom:1px solid #eee;">
          <td style="padding:12px 0; width:55%;">${desc}</td>
          <td style="text-align:center;">${qty}</td>
          <td style="text-align:right;">KES ${price}</td>
          <td style="text-align:right; font-weight:600;">KES ${amount}</td>
        </tr>`;
      });

      const issueDate = new Date(document.getElementById('invoiceDate').value).toLocaleDateString('en-GB', {day:'numeric', month:'short', year:'numeric'});
      const dueDate = new Date(document.getElementById('dueDate').value).toLocaleDateString('en-GB', {day:'numeric', month:'short', year:'numeric'});
      const totalFmt = total.toLocaleString('en-KE', {minimumFractionDigits: 2});

      document.getElementById('invoicePreview').innerHTML = `
<div style="font-family: 'Segoe UI', Arial, sans-serif; max-width:800px; margin:auto; border:1px solid #ddd;">

  <!-- Header Gradient -->
  <div style="background: linear-gradient(135deg, #4c1d95, #7c3aed); color:white; padding:20px 40px; display:flex; justify-content:space-between; align-items:center;">
    <div style="display:flex; align-items:center; gap:15px;">
      ${logoURL ? `<img src="${logoURL}" style="height:60px; border-radius:8px;">` : ''}
      <h1 style="margin:0; font-size:26px;">${document.getElementById('companyName').value}</h1>
    </div>
    <div style="text-align:right;">
      <h1 style="margin:0; font-size:32px;">INVOICE</h1>
      <h2 style="margin:5px 0 0; font-size:18px;"># ${document.getElementById('invoiceNo').value}</h2>
    </div>
  </div>

  <!-- Date Boxes -->
  <div style="padding:30px 40px 20px; display:flex; gap:20px; flex-wrap:wrap; background:#f8f9ff;">
    <div style="background:#e0e7ff; padding:12px 20px; border-radius:10px; min-width:160px;">
      <small style="color:#6366f1;">ISSUE DATE</small><br>
      <strong style="font-size:18px;">${issueDate}</strong>
    </div>
    <div style="background:#e0e7ff; padding:12px 20px; border-radius:10px; min-width:160px;">
      <small style="color:#6366f1;">DUE DATE</small><br>
      <strong style="font-size:18px;">${dueDate}</strong>
    </div>
    <div style="background:#d1fae5; padding:12px 30px; border-radius:10px; margin-left:auto;">
      <small style="color:#059669;">AMOUNT DUE</small><br>
      <strong style="font-size:24px; color:#065f46;">KES ${totalFmt}</strong>
    </div>
  </div>

  <!-- From /To -->
  <div style="padding:0 40px; display:grid; grid-template-columns:1fr 1fr; gap:40px; margin:30px 0;">
    <div>
      <h3 style="border-bottom:3px solid #4c1d95; padding-bottom:8px; display:inline-block;">From</h3>
      <strong style="font-size:18px;">${document.getElementById('companyName').value}</strong><br>
      ${document.getElementById('companyAddress').value.replace(/\n/g, '<br>')}<br>
      ${document.getElementById('companyPhone').value}
    </div>
    <div>
      <h3 style="border-bottom:3px solid #7c3aed; padding-bottom:8px; display:inline-block;">To</h3>
      <strong style="font-size:18px;">${document.getElementById('clientName').value}</strong><br>
      ${document.getElementById('clientAddress').value.replace(/\n/g, '<br>')}
    </div>
  </div>

  <!-- Items Table -->
  <div style="margin:40px 40px 20px;">
    <table style="width:100%; border-collapse:collapse;">
      <thead>
        <tr style="background:#e0e7ff; color:#4c1d95;">
          <th style="padding:15px; text-align:left;">Description</th>
          <th style="padding:15px; text-align:center;">Qty</th>
          <th style="padding:15px; text-align:right;">Rate</th>
          <th style="padding:15px; text-align:right;">Amount</th>
        </tr>
      </thead>
      <tbody>${itemsHTML}</tbody>
    </table>
  </div>

  <!-- Totals -->
  <div style="margin:30px 40px 40px; text-align:right;">
    <div style="display:inline-block; background:#f3f4f6; padding:15px 30px; border-radius:10px;">
      <div style="font-size:16px; margin-bottom:8px;">
        <span>Subtotal:</span>
        <strong style="margin-left:30px;">KES ${totalFmt}</strong>
      </div>
      <div style="font-size:20px; font-weight:bold; color:#4c1d95;">
        <span>Total:</span>
        <strong style="margin-left:30px;">KES ${totalFmt}</strong>
      </div>
    </div>
  </div>

  <!-- Payment Section -->
  ${(() => {
    const paymentType = document.querySelector('input[name="paymentType"]:checked').value;
    const mpesaNumber = document.getElementById('mpesaNumber').value;
    const mpesaTill = document.getElementById('mpesaTill').value;
    const hasPayment = (paymentType === 'number' && mpesaNumber) || (paymentType === 'till' && mpesaTill);
    
    if (!hasPayment) return '';
    
    if (paymentType === 'number') {
      return `<div style="padding:30px 40px; background:#f0fdf4; border-top:2px solid #22c55e;">
        <h3 style="color:#15803d; margin-top:0;">Payment Instructions</h3>
        <p style="margin:10px 0; font-size:16px; color:#166534;">
          <strong>Send Money to MPESA Number</strong><br>
          MPESA Number: <strong>${mpesaNumber}</strong>
        </p>
      </div>`;
    } else {
      return `<div style="padding:30px 40px; background:#f0fdf4; border-top:2px solid #22c55e;">
        <h3 style="color:#15803d; margin-top:0;">Payment Instructions</h3>
        <p style="margin:10px 0; font-size:16px; color:#166534;">
          <strong>Send Money to MPESA Till</strong><br>
          MPESA Till Number: <strong>${mpesaTill}</strong>
        </p>
      </div>`;
    }
  })()}

</div>`;

      document.getElementById('invoicePreview').classList.remove('hidden');
    }

    async function downloadPDF() {
      previewInvoice();
      await new Promise(r => setTimeout(r, 800)); // wait for logo

      const element = document.getElementById('invoicePreview');
      const canvas = await html2canvas(element, {scale: 2, useCORS: true});
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      const width = pdf.internal.pageSize.getWidth();
      const height = (canvas.height * width) / canvas.width;
      pdf.addImage(imgData, 'PNG', 0, 0, width, height);
      pdf.save(`${document.getElementById('invoiceNo').value}.pdf`);
    }

    // Initial calculation
    calculateTotal();
  </script>
</body>
</html>
